
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>blog.joshmcarthur.com</title>
  <meta name="author" content="@sudojosh">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.joshmcarthur.com/index.html"/>
  <link href="/favicon.ico" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog.joshmcarthur.com" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>


<body  >
  <div id="container">
      <header><hgroup>
  <h1><a href="/">blog.joshmcarthur.com</a></h1>
  
</hgroup>



</header>

      <div id="main" role="main">
        <div id="content">
          <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/11/03/generating-gem-install-commands-from-gem-list/">Generating &#8216;Gem Install&#8217; Commands From &#8216;Gem List&#8217;</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-11-03T16:34:00+13:00" pubdate  data-updated="true" >Nov 3<span>rd</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Here at <a href="http://3months.com">3Months</a>, we have a couple of monolithic projects that have been around for yonks - because of this, they don&#8217;t have bundler set up, and many of them have incomplete or out-of-date gem requirements. Yesterday I needed to get one of these projects set up locally for the first time, so I was kindly lent the output of <code>gem list</code> with which to install the gems at the correct versions required.</p>

<p>To make this problem a little easier in the future, I wrote a quick script to generate a massive shell command to install all the gems recorded in <code>gem list</code>. Next time I, or someone else, needs to set up one of these types of project, I can run this script, and hand them the generated shell script. They can run this in their gemset of choice, and install all gems required - much easier!</p>

<p>Here&#8217;s the script - alternatively, you can check it out the <a href="https://gist.github.com/1335721">Gist</a>:</p>

<div><figure role=code> <div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1">#!/usr/bin/env ruby</span>
</div><div class='line'>
</div><div class='line'>
</div><div class='line'><span class="c1">### gem_to_command.rb ###############################################################</span>
</div><div class='line'><span class="c1"># Produce a command to install the gems you currently have installed (using gem list)</span>
</div><div class='line'><span class="c1"># Makes a simple Shell script that can be run on Linux or Mac OS X</span>
</div><div class='line'><span class="c1"># </span>
</div><div class='line'><span class="c1"># Author: @sudojosh</span>
</div><div class='line'><span class="c1">######################################################################################</span>
</div><div class='line'>
</div><div class='line'><span class="n">gems</span> <span class="o">=</span> <span class="sb">`gem list`</span>
</div><div class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;install_gems.sh&quot;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">script</span><span class="o">|</span>
</div><div class='line'>  <span class="n">script</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;#!/usr/bin/env ruby</span><span class="se">\n</span><span class="s2">&quot;</span>
</div><div class='line'>  <span class="n">gems</span> <span class="o">=</span> <span class="n">gems</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</div><div class='line'>    <span class="n">gem</span> <span class="o">=</span> <span class="n">gem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">part</span><span class="o">|</span>
</div><div class='line'>      <span class="n">part</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[^\w\.\-]/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</div><div class='line'>    <span class="p">};</span>
</div><div class='line'>    <span class="o">[</span><span class="n">gem</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">gem</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">min</span><span class="o">]</span>
</div><div class='line'>
</div><div class='line'>  <span class="p">}</span>
</div><div class='line'>  <span class="n">gems</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</div><div class='line'>    <span class="n">script</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;gem install </span><span class="si">#{</span><span class="n">gem</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="si">}</span><span class="s2"> -v=</span><span class="si">#{</span><span class="n">gem</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</div><div class='line'>    <span class="n">script</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot; &amp;&amp; &quot;</span> <span class="k">unless</span> <span class="n">gem</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">gems</span><span class="o">.</span><span class="n">last</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</div><div class='line'>  <span class="p">}</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'><span class="nb">puts</span> <span class="s2">&quot;Wrote install_gems.sh&quot;</span>
</div></code></pre></td></tr></table></div></figure></div>


<p>Here&#8217;s what it does:</p>

<ul>
<li>Get the output of <code>gem list</code></li>
<li>Open a .sh file for writing</li>
<li>Iterate through the <code>gem list</code> output, and parse from the file the name of the gem and the lowest version number (lowest is safer than highest, even though there <em>should</em> only ever be one)</li>
<li>Assemble a <code>gem install</code> command with the <code>--no-rdoc --no-ri</code> arguments, and write this to the file.</li>
</ul>


<p>Enjoy!</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/20/a-fun-little-bookmarklet/">A Fun Little Bookmarklet</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-20T13:28:00+13:00" pubdate  data-updated="true" >Oct 20<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>I&#8217;m sure this has been done before, but after noticing <a href="http://www.1-day.co.nz">1-day&#8217;s</a>  &#8216;Look Busy&#8217; feature, I just had to write a bookmarklet to load this up on any site!</p>

<p>If you just want to try it out, here&#8217;s the link <a href="javascript:var busy=document.createElement('div');var body=document.getElementsByTagName('body')[0];var max_width_cache=body.getAttribute('max-width');body.style.maxWidth='100%';busy.setAttribute('id','lookbusy');busy.setAttribute('style','position: absolute; z-index: 1000; width: 100%; height: 100%; top: 0px; left: 0px; right: 0px; bottom: 0px; background: #FFF url(http://www.1-day.co.nz/images/2010_mission_critical_development_strategy.png) no-repeat 0 0;');var close=document.createElement('a');close.setAttribute('class','busy close');close.setAttribute('style','position: fixed; z-index: 1001; right: 10px; bottom: 10px; background-color: #FFF; color: #000; font-size:10px');close.setAttribute('href','#');close.innerText='OK, Clear';close.setAttribute('onclick',&quot;javascript:body.removeChild(document.getElementById('lookbusy'));body.style.maxWidth = &quot; + max_width_cache);busy.appendChild(close);body.appendChild(busy)">Look Busy Bookmarklet</a> - either right-click on the link and &#8216;Copy URL&#8217; and paste into a new bookmark, or drag to your bookmarks bar or folder. It should work in Chrome, Safari, Firefox and IE7-9</p>

<p>Here&#8217;s the source code for anyone interested in seeing how this works:</p>

<div><figure role=code><figcaption><span>Look Busy Bookmarklet  </span></figcaption>
 <div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
</pre></td><td class='code' width='100%'><pre><code class='javascript'><div class='line'><span class="c1">// Create a new div tag to contain our image</span>
</div><div class='line'><span class="kd">var</span> <span class="nx">busy</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</div><div class='line'><span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;body&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</div><div class='line'><span class="kd">var</span> <span class="nx">max_width_cache</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">maxWidth</span><span class="p">;</span>
</div><div class='line'><span class="nx">body</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">maxWidth</span> <span class="o">=</span> <span class="s1">&#39;100%&#39;</span><span class="p">;</span>
</div><div class='line'><span class="nx">busy</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;lookbusy&#39;</span><span class="p">);</span>
</div><div class='line'>
</div><div class='line'><span class="c1">// Add a background image, and position the div tag above all other content and make it fill the screen</span>
</div><div class='line'><span class="nx">busy</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;position: absolute; z-index: 1000; width: 100%; height: 100%; top: 0px; left: 0px; right: 0px; bottom: 0px; background: #FFF url(http://www.1-day.co.nz/images/2010_mission_critical_development_strategy.png) no-repeat 0 0;&#39;</span><span class="p">);</span>
</div><div class='line'>
</div><div class='line'><span class="c1">// Add a inconspicuous link to close the image</span>
</div><div class='line'><span class="kd">var</span> <span class="nx">close</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
</div><div class='line'><span class="nx">close</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;busy close&#39;</span><span class="p">);</span>
</div><div class='line'><span class="nx">close</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;style&#39;</span><span class="p">,</span> <span class="s1">&#39;position: fixed; z-index: 1001; right: 10px; bottom: 10px; background-color: #FFF; color: #000; font-size:10px&#39;</span><span class="p">);</span>
</div><div class='line'><span class="nx">close</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">);</span>
</div><div class='line'><span class="nx">close</span><span class="p">.</span><span class="nx">innerText</span> <span class="o">=</span> <span class="s2">&quot;OK, Clear&quot;</span><span class="p">;</span>
</div><div class='line'><span class="nx">close</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;onclick&#39;</span><span class="p">,</span> <span class="s2">&quot;javascript:body.removeChild(document.getElementById(&#39;lookbusy&#39;));body.style.maxWidth = &quot;</span> <span class="o">+</span> <span class="nx">max_width_cache</span><span class="p">);</span>
</div><div class='line'>
</div><div class='line'><span class="c1">// Add the close image to the look busy div tag</span>
</div><div class='line'><span class="nx">busy</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">close</span><span class="p">);</span>
</div><div class='line'>
</div><div class='line'><span class="c1">// Add the look busy div tag to the body of the document</span>
</div><div class='line'><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">busy</span><span class="p">);</span>
</div></code></pre></td></tr></table></div></figure></div>


<p>Give it a go! It&#8217;s super handy for when you&#8217;re checking out <a href="http://www.trademe.co.nz">TradeMe</a>, <a href="http://failblog.org">Failblog</a>, or <a href="http://images.google.com?q=wink">anything similar</a>!</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/19/init-dot-d-script-for-virtualbox-vms/">Safely Start and Stop VirtualBox VMs With init.d</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-19T17:05:00+13:00" pubdate  data-updated="true" >Oct 19<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Recently I&#8217;ve rolled out a virtual machine host box to run headless VMs (headless means that there is no display, keyboard etc plugged into it), as these make great test and experiment machines for trying new things out. As part of this rollout, I mashed a couple of blogs and some documentation together and came up with this script:</p>

<div><figure role=code><figcaption><span>/etc/init.d/virtual_machines  </span></figcaption>
 <div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
</pre></td><td class='code' width='100%'><pre><code class='bash'><div class='line'><span class="c">#!/bin/sh</span>
</div><div class='line'>
</div><div class='line'><span class="c"># virtual_machines  Start and stop virtual machines when the host changes state</span>
</div><div class='line'><span class="c">#</span>
</div><div class='line'><span class="c">#</span>
</div><div class='line'><span class="nv">VMUSER</span><span class="o">=</span>administrator
</div><div class='line'>
</div><div class='line'><span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
</div><div class='line'>    start<span class="o">)</span>
</div><div class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Starting VirtualBox VMs&quot;</span>
</div><div class='line'>        <span class="k">if</span> <span class="o">[</span> -f /etc/virtualbox/machines_enabled <span class="o">]</span>; <span class="k">then</span>
</div><div class='line'><span class="k">            </span>cat /etc/virtualbox/machines_enabled | <span class="k">while </span><span class="nb">read </span>VM; <span class="k">do</span>
</div><div class='line'><span class="k">              </span>sudo -H -b -u <span class="nv">$VMUSER</span> /usr/bin/VBoxHeadless -startvm <span class="s2">&quot;$VM&quot;</span>
</div><div class='line'>            <span class="k">done</span>
</div><div class='line'><span class="k">        fi</span>
</div><div class='line'>        ;;
</div><div class='line'>    stop<span class="o">)</span>
</div><div class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Saving state of VirtualBox VM...&quot;</span>
</div><div class='line'>        cat /etc/virtualbox/machines_enabled | <span class="k">while </span><span class="nb">read </span>VM; <span class="k">do</span>
</div><div class='line'><span class="k">          </span>sudo -H -u <span class="nv">$VMUSER</span> /usr/bin/VBoxManage controlvm <span class="s2">&quot;$VM&quot;</span> savestate
</div><div class='line'>        <span class="k">done</span>
</div><div class='line'>        ;;
</div><div class='line'>    *<span class="o">)</span>
</div><div class='line'>        <span class="nb">echo</span> <span class="s2">&quot;Usage: /etc/init.d/virtual_machines {start|stop}&quot;</span>
</div><div class='line'>        <span class="nb">exit </span>1
</div><div class='line'>        ;;
</div><div class='line'><span class="k">esac</span>
</div><div class='line'>
</div><div class='line'><span class="nb">exit </span>0
</div></code></pre></td></tr></table></div></figure></div>


<p>I wrote this because this isn&#8217;t something that is supported directly by VirtualBox, and it&#8217;s essential that on a headless server that these virtual machines be able to go up and down happily without harm and reliably. It supports start and stop explanations and uses savestate, rather than poweroff - essentially, as the host server goes down, it will &#8216;hibernate&#8217; each VM, and then restore when the server starts back up again.</p>

<p>Another feature that I built into this was the use of a file in which a list of VMs can be specified to start and stop - for example, if you only want this script to deal with a subset of the virtual machines you have set up on the host server.</p>

<p>An example of this file might look like this:</p>

<div><figure role=code><figcaption><span>/etc/virtualbox/virtual_machines </span></figcaption>
<div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
</pre></td><td class='code' width='100%'><pre><code class=''><div class='line'>winxp_development
</div><div class='line'>win7_development
</div><div class='line'>ubuntu_11_10_development</div></code></pre></td></tr></table></div></figure></div>


<p>It works really well for me, and since it&#8217;s something I had trouble tracking down, hopefully I can make someone&#8217;s life a little easier with this solution.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/06/action-mailer-interceptors/">Action Mailer Interceptors</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-06T16:51:00+13:00" pubdate  data-updated="true" >Oct 6<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>ActionMailer Interceptors are a great way to test the full stack of your mailing in Rails from the generation from data through to receiving the email in your client. They are similar to ActiveRecord&#8217;s <code>before_x</code>-type callbacks, and let you change something about the message being sent right before it&#8217;s actually dispatched.</p>

<p>The most common purpose I use these for is to redirect mail being sent from the application to either my Inbox, or some shared account (if it&#8217;s on a project where I&#8217;m not the only developer). This lets me make sure that the HTML in the message is displayed properly, and that the data gets injected into the content the way I expect it to be.</p>

<p>Here&#8217;s a quick example of how to use a Mail interceptor for this purpose:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># lib/development_mail_interceptor.rb</span>
</div><div class='line'><span class="k">class</span> <span class="nc">DevelopmentMailInterceptor</span>
</div><div class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delivering_email</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
</div><div class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span>
</div><div class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="s2">&quot;me@mywork.co.nz&quot;</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># config/initializers/mail_interceptors.rb</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;development_mail_interceptor&#39;</span>
</div><div class='line'><span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">register_interceptor</span><span class="p">(</span><span class="no">DevelopmentMailInterceptor</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</div></code></pre></td></tr></table></div></figure>

<p>&#8230;and give one of your mailers a go.</p>

<p>This is a very simple example, of course, but there are a lot of uses for this type of thing - logging &amp; auditing, checking against quotas, analysis, etc. etc.</p>

<p>What really triggered this post though, was a odd problem I came across when trying to get this interceptor to work. An ActionMailer method can be triggered using one of two methods: either <code>deliver</code> or <code>deliver!</code> - the main difference between the two is that the second will throw exceptions if it cannot be sent, which is why I tend to prefer using it. Something to keep in mind though, is that using <code>deliver!</code> will call any registered Mail Observers, but <strong>not Interceptors</strong> - meaning that your mail will be sent unaltered.</p>

<p>It really was a frustrating process to debug, but after looking at the <a href="https://github.com/mikel/mail">Mail gem</a> source code (ActionMailer back-ends onto this gem for it&#8217;s mail setup and delivery processes), in particular the <a href="https://github.com/mikel/mail/blob/master/lib/mail/message.rb#L227">Message class</a>, I noticed this crucial difference between the two. Resolving the issue is, of course, as simple as using <code>deliver</code> - without the exclamation mark. After that, your Interceptors will be triggered just as they should be.</p>
</div>
  
  


  </article>

<nav role="pagination">
  <div>
    
      <a class="prev" href="/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'blog-joshmcarthur';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>
<aside role=sidebar>
  
    <section>
  <h1>Search</h1>
  <form action="http://google.com/search" method="get" class="search">
    <fieldset role="site-search">
      <input type="hidden" name="q" value="site:blog.joshmcarthur.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/11/03/generating-gem-install-commands-from-gem-list/">Generating &#8216;Gem Install&#8217; Commands From &#8216;Gem List&#8217;</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/20/a-fun-little-bookmarklet/">A Fun Little Bookmarklet</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/19/init-dot-d-script-for-virtualbox-vms/">Safely Start and Stop VirtualBox VMs with init.d</a>
      </li>
    
      <li class="post">
        <a href="/2011/10/06/action-mailer-interceptors/">Action Mailer Interceptors</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/30/overriding-action-caches/">Overriding Action Caches</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/joshmcarthur">@joshmcarthur</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joshmcarthur',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("sudojosh", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/sudojosh" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @sudojosh</a>
  
</section>




  
</aside>

        </div>
      </div>
      <footer><p>
  Copyright &copy; 2011 - <a href="http://twitter.com/sudojosh">@sudojosh</a>
</p>
<p class="credits">
  <span class="octopress"><a href="http://octopress.org/">Octopress</a> powers this blog!</span>
  <span class="subtlepatterns"><a href="http://twitter.com/dwaseem">Waseem Dahman</a> made this beautiful background!</span>
<p>

</footer>
  </div>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>

