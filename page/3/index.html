
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>blog.joshmcarthur.com</title>
  <meta name="author" content="@sudojosh">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://joshmcarthur.com/blog/page/3/index.html"/>
  <link href="/favicon.ico" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog.joshmcarthur.com" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>


<body  >
  <div id="container">
      <header><hgroup>
  <h1><a href="/">blog.joshmcarthur.com</a></h1>
  
</hgroup>
<hgroup class="search">
    <form action="http://google.com/search" method="get">
      <fieldset role="site-search">
        <input type="hidden" name="q" value="site:joshmcarthur.com/blog" />
        <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      </fieldset>
    </form>
</hgroup>


</header>

      <div id="main" role="main">
        <div id="content">
          <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/21/rails-habtm-relationships-on-a-non-standard-connection/">Rails HABTM Relationships on a Non-standard Connection</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-06-21T00:00:00+12:00" pubdate  data-updated="true" >Jun 21<span>st</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Recently, I&#8217;ve been implementing an admin interface for a system that I want to
make more secure than the main application. The way I&#8217;ve chosen to do this is
to run some models that relate solely to the admin application (Authentication
and Authorization in particular), on a different database - let&#8217;s call it
&#8216;login&#8217;. This seems to be a reasonably common thing to do for security
purposes, and also for things like moving data from one database to another.
Once again though, I&#8217;ve been tempted into the potential nest of bugs that is
has_and_belongs_to_many - let me explain the schema first though: *
Administrators table - holds email, encrypted passwords and other data about
administrators * Roles table - holds the name of the role - used to authorizing
an administrator when performing an action. Each of these tables uses the line
<code>establish_connection 'login'</code> to connect to a different database than the
other models - this is the secure database that I want to leave purely for the
administrative application. So, given that I had an administrator that should
be given multiple roles, and obviously each role could have many
administrators, has_and_belongs_to_many seemed the obvious candidate - I didn&#8217;t
really want a model just for the association, and I would just need to write a
migration to create the join table. So, off, I went, and here&#8217;s what happened:
<code>ERROR: relation "administrators_roles" does not exist</code> i.e. - the
Administrator table exists, and the Role table exists, but the join table just
isn&#8217;t there. The first call for me was to take a look in the database, and make
sure that the table was there - which it was - and that migrations had
definitely run correctly and the schema was correct - which they were. After
much frustration, I found <a href="http://groups.google.com/group/%0Arubyonrails-talk/browse_thread/thread/7644d9e5f5c6e44a/%0A69c8cce4c39eb571?show_docid=69c8cce4c39eb571">this thread</a> which described the problems I
had been having - and I was vaguely satisfied to see that the problem wasn&#8217;t
really my fault. It seems that in some versions of Rails, ActiveRecord&#8217;s
has_and_belongs_to_many_association class doesn&#8217;t respect the database
connections that the models are trying to use - instead, it uses the universal
database connection to try and look up the join table - so, what was going
wrong was that ActiveRecord was looking in the development environment&#8217;s
database, when it should have been looking in the login database.
Unfortunately, short of updating your version of ActiveRecord/Rails or patching
this class, it seems that there isn&#8217;t really any way of avoiding this problem -
you have to drop back to using has_many :through with a Model representing your
join table. I can, though, at least vouch that once you have done this, it does
work as expected, which, in the end, is what we want. It still feels a bit
hacky though&#8230;.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/21/quick-rvmrc/">Quick: .rvmrc</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-06-21T00:00:00+12:00" pubdate  data-updated="true" >Jun 21<span>st</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>This post is probably something more experienced RVM users will already know,
but I wanted to post this as it&#8217;s definitely my discovery of the week. When
throwing an .rvmrc file into a project, it&#8217;s a nice thing to do to write the
script correctly so that it will just work for other developers (As well as
telling you what gemset you&#8217;re using when you jump into the directory). In your
.rvmrc file, put something like this: <code>rvm use 1.9.2@gemset --create</code> &#8230;this
will attempt to use that gemset (Printing out a nice message telling you it&#8217;s
using that one as it does so), and will create it if it doesn&#8217;t exist.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/16/ubuntu-quick-imagemagick-install/">Ubuntu: Quick ImageMagick Install</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-06-16T00:00:00+12:00" pubdate  data-updated="true" >Jun 16<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>[This is cross-posted from a tweet I posted a while back - I think it&#8217;s a nice
bit of advice, and I wanted to store it in a more persistent form]
Installing ImageMagick is one of the things that Rails developers need to do
reasonably often when provisioning new servers - basically, if you&#8217;re doing any
sort of image processing in your application (including the popularPaperclip
gem), ImageMagick is what you&#8217;ll be using.
The problem is that there is a bit of a magical formula I have needed to use in
the past - if you just install ImageMagick, it will most likely not work, as it
needs to have support for different image formats you want to use compiled it
in right from the get go. Previously, I have just looked up the various
libraries I have needed (For PNG, JPEG, etc.), and then either found the
libraries in the Ubuntu package repositories or built them from source.Â 
A nice quick way of doing it though, is to use an ImageMagick meta-package in
the Ubuntu repositories named libmagick-9-dev - it is just a collection of
popular image format libraries, as well as a couple of additional utilities for
ImageMagick. You can install it on any Ubuntu system by running this command:
sudo apt-get install libmagick-9-dev
ImageMagick itself still needs to be installed, of course. The best option here
is just to build from source - packages in the repositories are horribly out of
date, and I have found Paperclip, RMagick and Minimagick all require a fairly
recent version of ImageMagick.
Building from source sounds really intimidating, but it really isn&#8217;t - just
follow these steps:
First of all, download a tarball of the ImageMagick source onto your computer:
wget ftp://ftp.imagemagick.org/pub/ImageMagick/ImageMagick.tar.gz
Next, extract the tarball:
tar -xvzf ImageMagick.tar.gz
Now configure the package - note especially the end of the output (There is a
lot of output) - it tells you which Image libraries you have installed - any
with &#8216;yes&#8217; next to them it will happily format and convert - because you&#8217;ve
installed the package above, all the common formats should have a &#8216;yes&#8217; next to
them, but it&#8217;s worth checking.
cd ImageMagick-[VERSION] (VERSION will be a series of numbers like &#8216;6.7.0-8&#8217;)
./configure
Now all the hard work (By you) is done - you just need to compile the packages:
make &amp;&amp; sudo make install
All done! - ImageMagick should be all installed. To check, run the command
which identify, and check it returns a path to the &#8216;identify&#8217; command.
Note: If you have trouble compiling, make sure Ubunutu&#8217;s build tools are
installed: sudo apt-get install build-essential</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/06/11/integration-tests-with-devise-and-rspec/">Integration Tests With Devise and RSpec</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-06-11T00:00:00+12:00" pubdate  data-updated="true" >Jun 11<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>RSpec 2 has supported integration tests for a while now, and I&#8217;ve chosen to use
these for a project I&#8217;m working on at the moment instead of Cucumber (I don&#8217;t
feel that I need the verbosity andÂ English-like structure Cucumber provides
given that it a more complex process to write tests).
A bit of a problem I&#8217;ve come across recently is how to get a Devise user signed
in to your application in your tests, given that integration tests don&#8217;t really
give you any access to either the session or the controller (This rules out
manually setting ID&#8217;s in the session, or stubbing out current_user. As it turns
out, the implementation of it is pretty simple, but I did have to do a bit of
browsing and piece a few bits together to work out a nice way of doing it.
Here is the code you can use (You would normally place this within a before(:
each) filter in your routes spec (Which is what an integration test in RSpec is
called):
[At top of spec file, after require &#8216;spec_helper&#8217;
include Warden::Test::Helpers
[In a before(:each) block]
@user = Factory.create(:user)
@user.confirm!
login_as @user, :scope => :user
Now, what is this doing? Well, first of all, you include some test helpers that
Warden (Which devise back-ends onto), provides. I tried out using Devise&#8217;s
Devise::TestHelpers here, but it looks like Devise haven&#8217;t really designed
their helpers with integration tests in mind - they didn&#8217;t really work.Â 
Within our before(:each) block, it now gets pretty simple. We create a User,
using Factory Girl (This part of the implementation doesn&#8217;t really matter, you
can use fixtures if you prefer, or even a plain old User.create.
Next, we confirm the user. This isn&#8217;t necessary if your users haven&#8217;t been
marked as :confirmable in your User model, but obviously our new user needs to
be confirmed and active in order to log in.
Last of all, we use a helper method Warden&#8217;s test helpers has provided us to
log in the user, which sets us up for any more requests we need to make.
Have fun speccing nicely with Devise/Warden and RSpec!</p>
</div>
  
  


  </article>

<nav role="pagination">
  <div>
    
      <a class="prev" href="/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page/2/">Newer &rarr;</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'blog-joshmcarthur';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>
<aside role=sidebar>
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/09/14/introducing-blog-broadcaster/">Introducing Blog Broadcaster</a>
      </li>
    
      <li class="post">
        <a href="/2011/09/09/select-anything-from-everything/">Select Anything From Everything with Select</a>
      </li>
    
      <li class="post">
        <a href="/2011/08/22/capistrano-rvm-shell-command-not-found-error/">Capistrano rvm-shell: command not found error</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/23/achievements-on-coderwall/">Achievements on Coderwall</a>
      </li>
    
      <li class="post">
        <a href="/2011/07/14/arbitrary-ordering-in-postgresql-when-rails-enum-no/">Arbitrary Ordering in PostgreSQL when Rails + ENUM = No.</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/joshmcarthur">@joshmcarthur</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joshmcarthur',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("sudojosh", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/sudojosh" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @sudojosh</a>
  
</section>




  
</aside>

        </div>
      </div>
      <footer><p>
  Copyright &copy; 2011 - @sudojosh -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  </div>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>

