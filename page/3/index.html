
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>blog.joshmcarthur.com</title>
  <meta name="author" content="@sudojosh">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://blog.joshmcarthur.com/page/3/index.html"/>
  <link href="/favicon.ico" rel="shortcut icon" />
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog.joshmcarthur.com" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>


<body  >
  <div id="container">
      <header><hgroup>
  <h1><a href="/">blog.joshmcarthur.com</a></h1>
  
</hgroup>



</header>

      <div id="main" role="main">
        <div id="content">
          <div class="blog-index">



  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/10/06/action-mailer-interceptors/">Action Mailer Interceptors</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-10-06T16:51:00+13:00" pubdate  data-updated="true" >Oct 6<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>ActionMailer Interceptors are a great way to test the full stack of your mailing in Rails from the generation from data through to receiving the email in your client. They are similar to ActiveRecord&#8217;s <code>before_x</code>-type callbacks, and let you change something about the message being sent right before it&#8217;s actually dispatched.</p>

<p>The most common purpose I use these for is to redirect mail being sent from the application to either my Inbox, or some shared account (if it&#8217;s on a project where I&#8217;m not the only developer). This lets me make sure that the HTML in the message is displayed properly, and that the data gets injected into the content the way I expect it to be.</p>

<p>Here&#8217;s a quick example of how to use a Mail interceptor for this purpose:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="c1"># lib/development_mail_interceptor.rb</span>
</div><div class='line'><span class="k">class</span> <span class="nc">DevelopmentMailInterceptor</span>
</div><div class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">delivering_email</span><span class="p">(</span><span class="n">mail</span><span class="p">)</span>
</div><div class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="s2">&quot;&lt;</span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">to</span><span class="si">}</span><span class="s2">&gt; </span><span class="si">#{</span><span class="n">mail</span><span class="o">.</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span>
</div><div class='line'>    <span class="n">mail</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="s2">&quot;me@mywork.co.nz&quot;</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div><div class='line'>
</div><div class='line'><span class="c1"># config/initializers/mail_interceptors.rb</span>
</div><div class='line'><span class="nb">require</span> <span class="s1">&#39;development_mail_interceptor&#39;</span>
</div><div class='line'><span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">register_interceptor</span><span class="p">(</span><span class="no">DevelopmentMailInterceptor</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</div></code></pre></td></tr></table></div></figure>

<p>&#8230;and give one of your mailers a go.</p>

<p>This is a very simple example, of course, but there are a lot of uses for this type of thing - logging &amp; auditing, checking against quotas, analysis, etc. etc.</p>

<p>What really triggered this post though, was a odd problem I came across when trying to get this interceptor to work. An ActionMailer method can be triggered using one of two methods: either <code>deliver</code> or <code>deliver!</code> - the main difference between the two is that the second will throw exceptions if it cannot be sent, which is why I tend to prefer using it. Something to keep in mind though, is that using <code>deliver!</code> will call any registered Mail Observers, but <strong>not Interceptors</strong> - meaning that your mail will be sent unaltered.</p>

<p>It really was a frustrating process to debug, but after looking at the <a href="https://github.com/mikel/mail">Mail gem</a> source code (ActionMailer back-ends onto this gem for it&#8217;s mail setup and delivery processes), in particular the <a href="https://github.com/mikel/mail/blob/master/lib/mail/message.rb#L227">Message class</a>, I noticed this crucial difference between the two. Resolving the issue is, of course, as simple as using <code>deliver</code> - without the exclamation mark. After that, your Interceptors will be triggered just as they should be.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/30/overriding-action-caches/">Overriding Action Caches</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-30T11:48:00+13:00" pubdate  data-updated="true" >Sep 30<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>Recently, I have been working on a web application that is quite media rich, and is expected to run into quite a bit of traffic. I&#8217;ve been working on building an API for a front end system, using JSON to handle passing this data back and forth.</p>

<p>Obviously with this amount of traffic, and the size of some of the JSON collections we were having to marshall and store via Rails, we were going to need some pretty intense caching to reduce the load on Rails, and our database server. We had to balance this need, however, with the requirement that data should be live, or close to live (i.e. around 5-10 minutes) - in particular, statistics, which are calculated on-demand for several responses.</p>

<p>The strategy we chose to manage this balance was to use Rails&#8217; provided <code>caches_action</code> method to cache our JSON responses, building up a cache key from certain parameters, as well as some meta-data, for example, the user&#8217;s logged-in status. Because we were using memcached, we could use the <code>:expires_in</code> option to tell the memcached store to expire the cached value after x minutes.</p>

<p>This approach worked for a while, but we found we had a pretty major problem - while the data was cached, it went alright, but as soon as the cache expired we were having loads of users hitting a response that took way to long to build (before we optimized queries, 30+ seconds). So, we needed another fix.</p>

<p>To fix this problem, we tried out adding some cron tasks that used curl to ping the cached URLs, to try and preload the cache so that less users would be hitting the DB. This only partially fixed the problem though, so we identified a solution that would work a little better for us.</p>

<p>What we wanted to do was to leave our existing caching in place - aside from the expiry, it was working fine, and we didn&#8217;t want to rework everything. With this in mind though, we needed a way to force a refresh of the data in the cache external from the controller. What we ended up implementing was a monkeypatch on Rails&#8217; caches_action-related methods, that allows us to pass in an <code>:overwrite</code> option - this can be a Proc, or just a boolean - basically, when the value of <code>:overwrite</code> is true, Rails will bypass the cached value, grab the <em>new value</em>, and load this into the cache - effectively refreshing the value without a user having to trigger the process.</p>

<p>Here&#8217;s the monkeypatch code - have a scan through it, and I&#8217;ll explain it below:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
<span class='line'>13</span>
<span class='line'>14</span>
<span class='line'>15</span>
<span class='line'>16</span>
<span class='line'>17</span>
<span class='line'>18</span>
<span class='line'>19</span>
<span class='line'>20</span>
<span class='line'>21</span>
<span class='line'>22</span>
<span class='line'>23</span>
<span class='line'>24</span>
<span class='line'>25</span>
<span class='line'>26</span>
<span class='line'>27</span>
<span class='line'>28</span>
<span class='line'>29</span>
<span class='line'>30</span>
<span class='line'>31</span>
<span class='line'>32</span>
<span class='line'>33</span>
<span class='line'>34</span>
<span class='line'>35</span>
<span class='line'>36</span>
<span class='line'>37</span>
<span class='line'>38</span>
<span class='line'>39</span>
<span class='line'>40</span>
<span class='line'>41</span>
<span class='line'>42</span>
<span class='line'>43</span>
<span class='line'>44</span>
<span class='line'>45</span>
<span class='line'>46</span>
</pre></td><td class='code' width='100%'><pre><code class='ruby'><div class='line'><span class="nb">require</span> <span class="s1">&#39;set&#39;</span>
</div><div class='line'>
</div><div class='line'><span class="k">module</span> <span class="nn">ActionController</span> <span class="c1">#:nodoc:</span>
</div><div class='line'>  <span class="k">module</span> <span class="nn">Caching</span>
</div><div class='line'>
</div><div class='line'>    <span class="k">module</span> <span class="nn">Actions</span>
</div><div class='line'>    <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</div><div class='line'>
</div><div class='line'>      <span class="kp">protected</span>
</div><div class='line'>      <span class="k">class</span> <span class="nc">ActionCacheFilter</span> <span class="c1">#:nodoc:</span>
</div><div class='line'>        <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</div><div class='line'>          <span class="vi">@cache_path</span><span class="p">,</span> <span class="vi">@store_options</span><span class="p">,</span> <span class="vi">@cache_layout</span> <span class="o">=</span>
</div><div class='line'>            <span class="n">options</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="ss">:cache_path</span><span class="p">,</span> <span class="ss">:store_options</span><span class="p">,</span> <span class="ss">:layout</span><span class="p">)</span>
</div><div class='line'>        <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>        <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span>
</div><div class='line'>          <span class="n">path_options</span> <span class="o">=</span> <span class="k">if</span> <span class="vi">@cache_path</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:call</span><span class="p">)</span>
</div><div class='line'>            <span class="n">controller</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="vi">@cache_path</span><span class="p">)</span>
</div><div class='line'>          <span class="k">else</span>
</div><div class='line'>            <span class="vi">@cache_path</span>
</div><div class='line'>          <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>          <span class="n">cache_path</span> <span class="o">=</span> <span class="no">ActionCachePath</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="n">path_options</span> <span class="o">||</span> <span class="p">{})</span>
</div><div class='line'>          <span class="n">overwrite</span> <span class="o">=</span> <span class="k">if</span> <span class="vi">@overwrite</span> <span class="o">=</span> <span class="vi">@store_options</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:overwrite</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
</div><div class='line'>            <span class="vi">@overwrite</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:call</span><span class="p">)</span> <span class="p">?</span> <span class="n">controller</span><span class="o">.</span><span class="n">instance_exec</span><span class="p">(</span><span class="n">controller</span><span class="p">,</span> <span class="o">&amp;</span><span class="vi">@overwrite</span><span class="p">)</span> <span class="p">:</span> <span class="vi">@overwrite</span>
</div><div class='line'>          <span class="k">else</span>
</div><div class='line'>            <span class="kp">false</span>
</div><div class='line'>          <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>          <span class="n">body</span> <span class="o">=</span> <span class="n">overwrite</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">controller</span><span class="o">.</span><span class="n">read_fragment</span><span class="p">(</span><span class="n">cache_path</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="vi">@store_options</span><span class="p">)</span>
</div><div class='line'>
</div><div class='line'>          <span class="k">unless</span> <span class="n">body</span>
</div><div class='line'>            <span class="n">controller</span><span class="o">.</span><span class="n">action_has_layout</span> <span class="o">=</span> <span class="kp">false</span> <span class="k">unless</span> <span class="vi">@cache_layout</span>
</div><div class='line'>            <span class="k">yield</span>
</div><div class='line'>            <span class="n">controller</span><span class="o">.</span><span class="n">action_has_layout</span> <span class="o">=</span> <span class="kp">true</span>
</div><div class='line'>            <span class="n">body</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">_save_fragment</span><span class="p">(</span><span class="n">cache_path</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="vi">@store_options</span><span class="p">)</span>
</div><div class='line'>          <span class="k">end</span>
</div><div class='line'>
</div><div class='line'>          <span class="n">body</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">render_to_string</span><span class="p">(</span><span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">body</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">unless</span> <span class="vi">@cache_layout</span>
</div><div class='line'>          <span class="n">controller</span><span class="o">.</span><span class="n">response_body</span> <span class="o">=</span> <span class="n">body</span>
</div><div class='line'>          <span class="n">controller</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="no">Mime</span><span class="o">[</span><span class="n">cache_path</span><span class="o">.</span><span class="n">extension</span> <span class="o">||</span> <span class="ss">:html</span><span class="o">]</span>
</div><div class='line'>        <span class="k">end</span>
</div><div class='line'>      <span class="k">end</span>
</div><div class='line'>    <span class="k">end</span>
</div><div class='line'>  <span class="k">end</span>
</div><div class='line'><span class="k">end</span>
</div></code></pre></td></tr></table></div></figure>

<p>By dropping this code into <code>config/initializers</code>, this code gets patched into the ActionController::Caching::Actions::ActionCacheFilter class, and overrides the <code>initalize</code> and <code>filter</code> methods to let us a) pass in an override option, and b) choose to refresh the cache if the override option is set.</p>

<p>The filter method performs as normal until it has finished generating the cache path - at this point, it would normally return the cached response if it was there, and if it had not expired. Instead, my colleague <a href="http://telos.co.nz">James Moriaty</a> replaced some code here:</p>

<ul>
<li>First, it retrieves the value of the <code>:overwrite</code> option passed in to the <code>caches_action</code> method from the <code>@store_options</code> hash - if it&#8217;s a Proc, it executes it here to get the value, otherwise assumes it&#8217;s a boolean variable.</li>
<li>If the <code>:overwrite</code> option has not been passed in, it returns false - i.e. don&#8217;t overwrite the cache.</li>
<li>If the overwrite value is true, it sets the body to nil, so that it will be re-built. Otherwise, it does the usual and returns the cached response from Memcache.</li>
<li>From here, it more or less goes back to the default class, rebuilding the response from the database.</li>
</ul>


<p>In our application&#8217;s case, we use this functionality by tweaking our cron jobs a little to pass in a particular parameter - we then added the <code>:overwrite</code> option to our <code>caches_action</code> methods, with a Proc that returns true if this parameter equals the correct value.</p>

<p>So far, this solution has worked fantastically - now, hardly any of our users hit the database - instead, they are heading to memcache to grab that response, while our background cron jobs rebuild the data that will get returned to them. Using a parameter for refreshing the cache also lets us easily refresh manually for testing or to check for a value.</p>

<p>This solution is clean, simple and easy to implement. I suggest that if you are facing similar problems, that you give it a go - it&#8217;s really adaptable, and requires few changes if you are already using action caching. Full credit to James for thinking up and implementing this solution - I&#8217;m just documenting it.</p>
</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/23/howto-database-backup-and-restore/">Howto: Database Backup and Restore</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-23T13:26:00+12:00" pubdate  data-updated="true" >Sep 23<span>rd</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>An inherent part of developing web applications is managing your datastores - typically, a relational database such as MySQL or PostgreSQL. Today, I&#8217;m going to quickly cover off how to backup and restore for both of these databases.</p>

<h2>What you&#8217;ll need</h2>

<ul>
<li>Either PostgreSQL or MySQL</li>
<li>Access to a database (preferably one with data in it)</li>
</ul>


<h2>Why this is useful to know</h2>

<p>Lots of interactions with databases have the potential to destroy or modify data (in a bad way). When using frameworks such as Ruby on Rails, it&#8217;s even easier to, say, accidently delete all of your Users (Horribly easy in DataMapper, unfortunately). It&#8217;s important that before you do anything with data that&#8217;s destructive, you have a backup of your database that you can restore from quickly and easily.</p>

<h2>PostgreSQL</h2>

<p>Postgres databases are backed up using the <code>pg_dump</code> command - a command-line utility that comes packaged with the database server. Here&#8217;s the command:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class='sh'><div class='line'>pg_dump --no-owner -U <span class="o">[</span>username<span class="o">]</span> -W <span class="o">[</span>database_name<span class="o">]</span> &gt; <span class="o">[</span>file to dump to<span class="o">]</span>.sql.dump
</div></code></pre></td></tr></table></div></figure>

<p>Let me explain these options and why I use them:</p>

<ul>
<li><code>--no-owner</code>: By default, Postgres dumps the database with lots of SET OWNER TO statements. I like to take these out of the dump, as I&#8217;m not necessarily restoring the dump to exactly the same server with exactly the same users. Using &#8211;no-owner means that ownership statements will be excluded.</li>
<li><code>-U [username]</code>: This lets you pass in the database user name your web application usually uses to connect - using this is just good practise, as it ensures that what you&#8217;re dumping is exactly what the web application has.</li>
<li><code>-W</code>: This option, used in conjunction with the <code>-U</code> flag, prompts for the password when you run the command</li>
<li><code>[database_name]</code>: This is the name of the database that you want to dump</li>
<li><code>[file to dump to]</code>: This is the file that the SQL script that pg_dump produces will be piped into. I normally name this file with the <code>.sql.dump</code> extension, so that I can see it&#8217;s a SQL dump straight off.</li>
</ul>


<h4>Restoring a database dump</h4>

<p>Restoring a Postgresql dump is really easy, and involves using the standard <code>psql</code> client to connect to the database and execute the SQL script in your dump file.</p>

<p>First of all, make sure that you have created the database you want to load the data into. In this example, let&#8217;s say I&#8217;ve dumped from the <code>facebook_production</code> database to the file <code>facebook_production_23092011.sql.dump</code>, and I want to restore into the <code>facebook_development</code> database so that I can test out some code against some production data. I want to connect to the database using psql as the web application user, and load the dump in:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class='sh'><div class='line'>psql -U facebook -W facebook_development &lt; facebook_production_23092011.sql.dump<span class="sb">`</span>
</div></code></pre></td></tr></table></div></figure>

<p>Note how I am using the opposite of the less-than symbol I used above - this basically denotes the direction of the data - it&#8217;s coming <em>from</em> the file, going <em>to</em> the database.</p>

<p>Upon running this commmand (with your own database, of course), you will first be prompted for your database user&#8217;s password, and will then see a bunch of SQL statements being executed. Once it&#8217;s completed, your database has been loaded successfully - you can jump in using psql if you&#8217;d like, and query around a bit.</p>

<h2>MySQL</h2>

<p>MySQL databases are backed up with the <code>mysqldump</code> program - one I&#8217;m not as familiar with as Postgres, but I know the basics, and largely that&#8217;s all you need with this type of thing. The main thing to keep in mind is that the process is the same as for PostgreSQL above - use the dump program to write the database out to a file (in the form of SQL statements), and then use the database client program <code>mysql</code> in this case, to execute the commands in the file against the database being restored to. Here&#8217;s the command to dump a MySQL file to disk:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class='sh'><div class='line'>mysqldump -U <span class="o">[</span>username<span class="o">]</span> -P <span class="o">[</span>database_name<span class="o">]</span> &gt; <span class="o">[</span>file to dump to<span class="o">]</span>.sql.dump
</div></code></pre></td></tr></table></div></figure>

<p>The options are more or less as I&#8217;ve described above, except that <code>-P</code> is substituted for <code>-W</code>, and I&#8217;ve still stuck with the <code>.sql.dump</code> naming scheme.</p>

<h4>Restoring a database dump</h4>

<p>This process is almost identical to the PostgreSQL restore process. Let&#8217;s stick with the same example format we already have - dumping from a database called <code>facebook_production</code> to file <code>facebook_production_23092011.sql.dump</code>, restoring into a database called <code>facebook_development</code> - here&#8217;s the command we need for that:</p>

<figure role=code><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class='sh'><div class='line'>mysql -U facebook -P facebook_development &lt; facebook_production_23092011.sql.dump
</div></code></pre></td></tr></table></div></figure>

<p>Once again, you&#8217;ll be prompted for your password, but for this one you won&#8217;t see the output of the SQL statements - it will take a couple of seconds, and then the program will exit. This is normal however - if you&#8217;d like to see the output of the batch load, you can add <code>-v -v -v</code> before the <code>&lt;</code> symbol to turn verbosity to level three, otherwise you can go ahead and jump into your database and make sure everything is there.</p>

<h2>Tips:</h2>

<ul>
<li>If you don&#8217;t have a database user account yet, on Unix and Linux you can use <code>sudo su postgres</code> to login as the &#8216;postgres&#8217; user - a root-like database user that gets created for you when Postgres is installed. MySQL has a root account, but it&#8217;s not a system user - you are normally prompted for a root username and password when you install MySQL. If you <em>are</em> using the Postgres user, you don&#8217;t need to pass in a username or password in the above commands, but you need to remember that your restored databases will be owned by &#8216;postgres&#8217;, not you web application database user.</li>
<li>A handy place to put database dumps that you are planning to use right away is <code>/tmp</code> (Only on Unix and Linux). This is a directly that is writeable by everyone, that will get &#8216;garbage collected&#8217; periodically. This is especially handy if you are logging in as the &#8216;postgres&#8217; user, as typically this user won&#8217;t have write permissions on many other directories</li>
</ul>

</div>
  
  


  </article>


  <article>
    
  <header>
    
      <h1 class="entry-title"><a href="/2011/09/14/introducing-blog-broadcaster/">Introducing Blog Broadcaster</a></h1>
    
    
      <p class="meta">





  



<time datetime="2011-09-14T19:04:00+12:00" pubdate  data-updated="true" >Sep 14<span>th</span>, 2011</time></p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve just completed a Blog Broadcaster for this blog. It had a couple of interesting technical things, and I needed to test it properly, so here&#8217;s this post!</p>

<p>I recently migrated this blog from <a href="http://tumblr.com">Tumblr</a>, and while Tumblr was pretty awesome and easy to use, it didn&#8217;t have great support for blocks of code and preformatted comment, and, like <a href="http://www.radiantcms.org">Radiant CMS</a>, it stored layouts, stylesheets, and all of that kind of thing in a database somewhere - it wasn&#8217;t in source control, and making changes to it was dangerous.</p>

<p>One thing that I immediately missed from Tumblr, however, was it&#8217;s ability to post to Facebook and Twitter automatically whenever I published a post. As I don&#8217;t post that often, it&#8217;s really important to me that I market my blog as much as I can - like my Github profile, the content on my blog is a reflection of my knowledge and skill as a developer, and so I want to get that in front of people as much as possible - broadcasting to social networks is a great way of achieving that.</p>

<p>With my blog on Github, I needed a way to broadcast new posts to these social networks. Github has a built-in post-receive hook to post to Twitter, but I really needed something more than that. Here&#8217;s my list of requirements:</p>

<ul>
<li>It should automatically post without me needing to do any special task</li>
<li>It should be conditional - i.e. it shouldn&#8217;t post <em>everytime</em> I change something</li>
<li>It should support both Facebook and Twitter</li>
<li>It should be able to be triggered by a commit</li>
</ul>


<p>What I ended up building was a Sinatra app whose sole purpose was to receive POST&#8217;ed commit information, parse it into a Facebook and Twitter post, and broadcast it. It&#8217;s hosted on Heroku, and gets triggered by a Github <a href="http://help.github.com/post-receive-hooks/">Post-Receive Hooks</a>. I did run into a couple of problems along the way - the main one was sorting out being able to post Facebook updates without being logged in, or even needing to be involved at the process at all. This wasn&#8217;t too difficult, but I did need to get an access token that was long-lived, and have the ability to update this if necessary. I overcame this problem by adding some methods to my Sinatra app that will allow me to update the access token if it ever expires, or change the Facebook account used if necessary.</p>

<p>The second problem I ran into wasn&#8217;t really a problem, but it was a challenge to try and think of a nice way of doing it. Basically I needed to store the Facebook access token somewhere so that I could use it when I needed it - but I didn&#8217;t have a database, and I didn&#8217;t particularly want to add one just for storing a single string. Since this is running on Heroku (Bamboo stack, not Cedar), I was also on a read-only filesystem, so couldn&#8217;t store it in a simple text file either. In this end, I chose to store the value in Memcache using the Heroku add-on. This still isn&#8217;t necessarily a good solution, as this storage method isn&#8217;t guaranteed to be persistent, however it should suit my needs - it doesn&#8217;t particularly matter if I lose the access token, the application will gracefully degrade and just post to Twitter until I log in to Facebook via the app again.</p>

<p>So, I think I&#8217;ve come up with a good solution. It started off as a simple broadcaster for my blog, but I think it has a lot of potential for use with any open-source project that has social networking presence - I think it&#8217;s a much more elegant and flexible hook than that which Github provides, and I hope it get&#8217;s a bit of use.</p>
</div>
  
  


  </article>

<nav role="pagination">
  <div>
    
      <a class="prev" href="/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page/2/">Newer &rarr;</a>
    
  </div>
</nav>

<script type="text/javascript">
    var disqus_shortname = 'blog-joshmcarthur';
    (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</div>
<aside role=sidebar>
  
    <section>
  <h1>Search</h1>
  <form action="http://google.com/search" method="get" class="search">
    <fieldset role="site-search">
      <input type="hidden" name="q" value="site:blog.joshmcarthur.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/02/28/git-browse-for-quick-repo-viewing/">Git-browse for Quick Repo Viewing</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/08/treatme-lite-part-one-the-backend/">Treatme Lite: Part One - the Backend</a>
      </li>
    
      <li class="post">
        <a href="/2012/02/06/treatme-lite-adventures-in-javascript/">Treatme Lite: Adventures in Javascript</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/14/upcoming-ratemycourses/">Upcoming: RateMyCourses</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/12/add-jquery-to-any-page/">Add jQuery to Any Page Really, Really Easily</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/joshmcarthur">@joshmcarthur</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joshmcarthur',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("sudojosh", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/sudojosh" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @sudojosh</a>
  
</section>




  
</aside>

        </div>
      </div>
      <footer><p>
  Copyright &copy; 2012 - <a href="http://twitter.com/sudojosh">@sudojosh</a>
</p>
<p class="credits">
  <span class="octopress"><a href="http://octopress.org/">Octopress</a> powers this blog!</span>
  <span class="subtlepatterns"><a href="http://twitter.com/dwaseem">Waseem Dahman</a> made this beautiful background!</span>
<p>

</footer>
  </div>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>

