
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Select Anything From Everything with <select> - blog.joshmcarthur.com</title>
  <meta name="author" content="@sudojosh">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  

  <link rel="canonical" href="http://joshmcarthur.com/blog/2011/09/09/select-anything-from-everything/"/>
  <link href="/blog/favicon.ico" rel="shortcut icon" />
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="http://s3.amazonaws.com/ender-js/jeesh.min.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="blog.joshmcarthur.com" type="application/atom+xml"/>
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>

</head>


<body  >
  <div id="container">
      <header><hgroup>
  <h1><a href="/blog/">blog.joshmcarthur.com</a></h1>
  
</hgroup>
<hgroup class="search">
    <form action="http://google.com/search" method="get">
      <fieldset role="site-search">
        <input type="hidden" name="q" value="site:joshmcarthur.com/blog" />
        <input class="search" type="text" name="q" results="0" placeholder="Search"/>
      </fieldset>
    </form>
</hgroup>


</header>

      <div id="main" role="main">
        <div id="content">
          <div>
<article>
  
  <header>
    <h1 class="entry-title">Select Anything From Everything With <select></h1>
    <p class="meta">





  



<time datetime="2011-09-09T00:00:00+12:00" pubdate  data-updated="true" >Sep 9<span>th</span>, 2011</time></p>
  </header>
  
  <p>I was recently called upon to make a horrible select input for a Ruby on Rails project - essentially, there was this model, let&#8217;s call it a Snafu, and one Snafu could share an attachment to any number of models.</p>

<p>This select was difficult because I couldn&#8217;t just have a selection of record ID&#8217;s - I would have to use both the model type <strong>as well as</strong> the model ID in order to be able to track down these records when the form was submitted. Here&#8217;s how I did it:</p>

<p><strong>Step 1: Rendering the select </strong>
First of all, we need to render a selection box for the &#8216;New Snafu&#8217; form. This selection box should be populated by a number of model collections, keyed by an identifier that specifies both the model name and the model ID. Time for a model method, and a helper!</p>

<p>`</p>

<pre><code>def options_for_select_anything(selected = nil)
 #Make a hash of the things we want to select from
 options = {
  'Foo' =&gt; Foo.active.map(&amp;item_for_select_anything),
  'Bar' =&gt; Bar.active.map(&amp;item_for_select_anything)
 }
 #Use a Rails helper to actually get the tags
 grouped_options_for_select(options, selected)
end

def item_for_select_anything
 # Return an array of the record name and the identifier we want to use
 # The record name in this case is the display value, while the identifier
 # is the data value
 lambda { |record| [record.name, "#{record.id}-#{record.class.name}"] }
end
</code></pre>

<p>`</p>

<p>Now that we have these helpers, we have a grouped collection of options, in which each option tag within the select will look something like &#8217;<option value="1-Foo">Foo #1</option>&#8217; - let&#8217;s render our select.</p>

<p>`
&lt;% form_for @snafu do |form| %></p>

<p>
<%= form.label :item_identifier, 'Item' %><br />
<%= form.select :item_identifier, options_for_select_anything %>
</p>
<p>
<%= form.submit 'Create' %>
</p>
 <% end %>
`

This is a basic form of course - your form will have all the other attributes you need, but the key thing to notice here is that we aren&#8217;t trying to load against our Polymorphic &#8216;item&#8217; association within the form - instead, we&#8217;re just going to send through a &#8216;item_identifier&#8217; parameter that we can use to *find* the item in our model. Let&#8217;s take a look at the sections we need.

First of all, we need to have the Polymorphic association in our model, if you haven&#8217;t already done this.

`
# Snafu.rb

class Snafu < ActiveRecord::Base
# Snip
belongs_to :item, :polymorphic => true
# Snip
end

# Migration
add_column :snafus, :item_id, :integer, :null => false
add_column :snafus, :item_type, :string, :null => false

`

Next of all, we need to add an `attr_writer` to our model - this will hold the &#8216;item_identifier&#8217; from our form submission until we are ready to use it.
`
# Snafu.rb

attr_writer :item_identifier
`

Finally, we need to add a `before_validation` filter to associate the record identified by our item_identifier with our model instance:
`
# Snafu.rb
class Snafu < ActiveRecord::Base
# Snip
belongs_to :item, :polymorphic => true
before_validation :set_item

attr_writer :item_identifier

# Snip

private

def set_item
if self.item_identifier
id, model = self.item_identifier.split(&#8216;-&#8216;)
self.item = Kernel.const_get(model).send(:find, id) rescue nil
end
end
 end
`


Let&#8217;s take a look at what we&#8217;ve done there - really, the meat of it is in our set_item method, that gets called before validations run (so that we will have a real item set before we may need to run validations on that item). First of all, set_item checks that we have set a item_identifier - if we haven&#8217;t we don&#8217;t want to run into Nil exceptions! Given an item_identifier is present, we want to split our identifier (Remember, this is in the format id-class name), into two parts. Finally, we do a little Ruby magic to get the class using Kernel.const_get, and then call `find` on it with the ID that we want. If anything goes wrong with this bit (The class not existing, for example), then we just set item to nil.

There we have it then - it&#8217;s a horrible situation, but I feel like it&#8217;s a pretty good approach. The logic is where it should be (models and helpers), the views and controllers feel clean, and it&#8217;s flexible to be reused pretty easily.

As a final tweak, there&#8217;s one more change you may want to make - that is setting the selected item when we return to our form. If you take a look at the helper method we defined above, you&#8217;ll notice that we already support a selected option - we just need to pass this in. To do this, we want to add a method to our &#8216;Snafu&#8217; class that will return a string of the item id and the item name concatenated with a dash - i.e., the format that our select box in the form is expecting. Go ahead and add the method now:

`
# Snafu.rb

def item_identifier
# Return the owner_identifier set using the attr_writer, if it exists
return @owner_identifier if @owner_identifier

# Otherwise, try and build it from the current item saved against the model
[self.item.id, self.item.class.name].join(&#8216;-&#8216;) if self.item.present?
end
`

With that method, can can just change our select input in the form to make use of this value:

`
# new.html.erb
# Snip
<%= form.select :item_identifier, options_for_select_anything(form.object.item_identifier) %>
`

There we are! Now when we show the form, the selected item will appear, just as we wanted.


  
    <footer>
      <p class="meta">
        
        





  



<time datetime="2011-09-09T00:00:00+12:00" pubdate  data-updated="true" >Sep 9<span>th</span>, 2011</time>
        


      </p>
      
        <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://joshmcarthur.com/blog/2011/09/09/select-anything-from-everything/" data-via="sudojosh" data-counturl="http://joshmcarthur.com/blog/2011/09/09/select-anything-from-everything/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
</div>

      
    </footer>
  
</article>

</div>

<aside role=sidebar>
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2011/09/14/introducing-blog-broadcaster/">Introducing Blog Broadcaster</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/09/09/select-anything-from-everything/">Select Anything From Everything with <select></a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/08/22/capistrano-rvm-shell-command-not-found-error/">Capistrano rvm-shell: command not found error</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/07/23/achievements-on-coderwall/">Achievements on Coderwall</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/07/14/arbitrary-ordering-in-postgresql-when-rails-enum-no/">Arbitrary Ordering in PostgreSQL when Rails + ENUM = No.</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/joshmcarthur">@joshmcarthur</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'joshmcarthur',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/blog/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("sudojosh", 5, false);
    });
  </script>
  <script src="/blog/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/sudojosh" class="twitter-follow-button" data-width="208px" data-show-count="false">Follow @sudojosh</a>
  
</section>




  
</aside>


        </div>
      </div>
      <footer><p>
  Copyright &copy; 2011 - @sudojosh -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  </div>
  

  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>

